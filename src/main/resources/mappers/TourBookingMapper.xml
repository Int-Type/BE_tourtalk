<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="world.ssafy.tourtalk.model.mapper.TourBookingMapper">

	<!-- 현재 상품에 예약되어 있는 인원 확인 -->
	<select id="countParticipantsByProductAndTime" resultType="int">
		SELECT COALESCE(SUM(participant_count), 0)
		FROM tour_booking
		WHERE
		product_id = #{productId}
		AND time = #{time}
		AND status = 'RESERVED'
	</select>

	<!-- 상품 예약 -->
	<insert id="insert"
		parameterType="world.ssafy.tourtalk.model.dto.request.TourBookingRequest">
		INSERT INTO tour_booking (
		mno, product_id, time,
		reserved_at,
		participant_count,
		total_price, payment_method,
		payment_status, status
		) VALUES (
		#{mno}, #{productId}, #{time}, NOW(),
		#{participantCount},
		#{totalPrice}, #{paymentMethod},
		#{paymentStatus,
		typeHandler=world.ssafy.tourtalk.model.typehandler.GenericEnumTypeHandler,
		javaType=world.ssafy.tourtalk.model.dto.enums.PaymentStatus},
		#{status,
		typeHandler=world.ssafy.tourtalk.model.typehandler.GenericEnumTypeHandler,
		javaType=world.ssafy.tourtalk.model.dto.enums.BookingStatus}
		)
	</insert>


	<select id="getBookingCountByProduct"
		resultType="world.ssafy.tourtalk.model.dto.response.TourBookingResponse">
		SELECT
		time,
		SUM(participant_count) AS participantCount
		FROM
		tour_booking
		WHERE product_id = #{productId}
		AND status = 'RESERVED'
		GROUP BY time
	</select>

</mapper>